#!/usr/bin/env bash
# ==========================================================
# Intel Arc GPU Power & Frequency Monitor (Pro Edition)
# Version: 1.2 (2025-10)
# Author: ChatGPT (OpenAI)
# License: MIT
#
# Description:
#   A lightweight, safe, and extensible telemetry viewer for
#   Intel Arc GPUs using sysfs interfaces. Designed for both
#   live monitoring and logging with minimal CPU overhead.
#
# Usage:
#   sudo ./intel-arc-monitor-pro.sh [options]
#
# Options:
#   --interval <secs>   Refresh rate (default: 0.5)
#   --log <file>        Append readings to a log file
#   --color             Enable colored output (green/amber/red)
#   -h | --help         Display this help
#
# Examples:
#   sudo ./intel-arc-monitor-pro.sh
#   sudo ./intel-arc-monitor-pro.sh --interval 1 --log /tmp/arc.log
#   sudo ./intel-arc-monitor-pro.sh --color
#
# ==========================================================

set -euo pipefail
IFS=$'\n\t'

# --- Default settings ---
INTERVAL=0.5
LOG_MODE=false
LOG_FILE=""
USE_COLOR=false
DRM_BASE="/sys/class/drm/card0"

# --- CLI argument parser ---
while [[ $# -gt 0 ]]; do
    case "$1" in
        --interval)
            INTERVAL="${2:-0.5}"
            shift 2
            ;;
        --log)
            LOG_MODE=true
            LOG_FILE="$2"
            shift 2
            ;;
        --color)
            USE_COLOR=true
            shift
            ;;
        -h|--help)
            grep '^#' "$0" | sed 's/^# \{0,1\}//'
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Try --help for usage."
            exit 1
            ;;
    esac
done

# --- Helper: read sysfs file safely ---
read_sysfs() {
    local file="$1" val
    if [[ -f "$file" ]]; then
        read -r val < "$file" || val="N/A"
        echo "$val"
    else
        echo "N/A"
    fi
}

# --- Auto-detect hwmon directory for Intel GPU ---
detect_hwmon() {
    local candidate
    for candidate in /sys/class/hwmon/hwmon*; do
        if [[ -d "$candidate" ]] && grep -q "card0" "$candidate"/device/uevent 2>/dev/null; then
            echo "$candidate"
            return
        fi
    done
    echo "/sys/class/hwmon/hwmon0"
}

HWMON_BASE="$(detect_hwmon)"

# --- Detect GT engines ---
mapfile -t GT_LIST < <(ls -d "$DRM_BASE"/gt/gt* 2>/dev/null || true)
if [[ ${#GT_LIST[@]} -eq 0 ]]; then
    echo "❌ Error: No GT engines found in $DRM_BASE/gt/"
    exit 1
fi

# --- Prepare logging ---
if $LOG_MODE; then
    echo "📝 Logging enabled → $LOG_FILE"
    echo "# Timestamp Power(W) Voltage(mV) ActFreq(MHz)" > "$LOG_FILE"
fi

# --- Setup terminal and cleanup trap ---
tput civis || true
cleanup() { tput cnorm 2>/dev/null || true; echo; exit 0; }
trap cleanup INT TERM

# --- Optional color formatting ---
colorize() {
    local value="$1" color="$2"
    if $USE_COLOR; then
        case "$color" in
            red) printf "\033[1;31m%s\033[0m" "$value" ;;
            yellow) printf "\033[1;33m%s\033[0m" "$value" ;;
            green) printf "\033[1;32m%s\033[0m" "$value" ;;
            *) printf "%s" "$value" ;;
        esac
    else
        printf "%s" "$value"
    fi
}

# --- Main loop ---
while :; do
    read -r P1 < "$HWMON_BASE/energy1_input"
    sleep "$INTERVAL"
    read -r P2 < "$HWMON_BASE/energy1_input"
    POWER=$(( (P2 - P1) / 252525 ))

    VOLTAGE=$(read_sysfs "$HWMON_BASE/in0_input")
    POWER_LIMIT_RAW=$(read_sysfs "$HWMON_BASE/power1_max")
    if [[ "$POWER_LIMIT_RAW" =~ ^[0-9]+$ ]]; then
        POWER_LIMIT=$(( POWER_LIMIT_RAW / 1000000 ))
    else
        POWER_LIMIT="N/A"
    fi

    ACT_FREQ=$(read_sysfs "${GT_LIST[0]}/rps_act_freq_mhz")
    THROTTLE_STATUS=$(read_sysfs "${GT_LIST[0]}/throttle_reason_status")

    # --- Apply color if enabled ---
    if $USE_COLOR; then
        if [[ "$THROTTLE_STATUS" == "0x0" ]]; then
            POWER_STR=$(colorize "$POWER" green)
        else
            POWER_STR=$(colorize "$POWER ⚠" red)
        fi
    else
        POWER_STR="$POWER"
    fi

    # --- Display ---
    printf "\033[H\033[J"
    echo "============================="
    echo
    echo "Power Usage: ${POWER_STR} Watts"
    echo "Voltage: $VOLTAGE mV"
    echo "RPS ACT Freq: $ACT_FREQ MHz"
    echo "Power Limit: $POWER_LIMIT Watts"
    echo "Throttle Status: $THROTTLE_STATUS"
    echo
    echo "============================="

    # --- Per-GT metrics (compact) ---
    for GT in "${GT_LIST[@]}"; do
        echo "--- $(basename "$GT") ---"
        echo "REQ: $(read_sysfs $GT/punit_req_freq_mhz) MHz | " \
             "CUR: $(read_sysfs $GT/rps_cur_freq_mhz) MHz | " \
             "MAX: $(read_sysfs $GT/rps_max_freq_mhz) MHz"
        echo "Throttle: $(read_sysfs $GT/throttle_reason_status)"
        echo
    done

    # --- Logging (if enabled) ---
    if $LOG_MODE; then
        printf "%s %s %s %s\n" "$(date +'%F %T')" "$POWER" "$VOLTAGE" "$ACT_FREQ" >> "$LOG_FILE"
    fi
done
